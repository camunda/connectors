name: Integration test

on:
  pull_request:
  workflow_dispatch:
    inputs:
      connectors_version:
        description: 'The version of the connectors to test'
        required: true
        default: '8.5.0-alpha2'

defaults:
  run:
    # use bash shell by default to ensure pipefail behavior is the default
    # see https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#exit-codes-and-error-action-preference
    shell: bash

jobs:
  helm-deploy:
    name: Helm chart Integration Tests
    uses: camunda/camunda-platform-helm/.github/workflows/test-integration-template.yaml@main
    secrets: inherit
    with:
      identifier: connectors-int-${{ github.run_id }}
      persistent: true
      test-enabled: true
      extra-values: |
        # Console is still pre-alpha, and it has a different test flow.
        zeebe:
          image:
            tag: 8.5.0-alpha2
        tasklist:
          image:
            tag: 8.5.0-alpha2
        operate:
          image:
            tag: 8.5.0-alpha2
        webModeler:
          restapi:
            image:
              tag: latest
          webapp:
            image:
              tag: latest
          websockets:
            image:
              tag: latest
        console:
          enabled: false
        identity:
          image:
            tag: SNAPSHOT
          firstUser:
            existingSecret: null
            user: demo
            password: ${{ vars.DISTRO_QA_E2E_TESTS_IDENTITY_FIRSTUSER_PASSWORD }}
          # Keycloak client seed which is used to query Camunda APIs. 
          env:
          - name: KEYCLOAK_CLIENTS_2_ID
            value: venom
          - name: KEYCLOAK_CLIENTS_2_NAME
            value: Venom
          - name: KEYCLOAK_CLIENTS_2_SECRET
            valueFrom:
              secretKeyRef:
                name: integration-test
                key: client-secret
          - name: KEYCLOAK_CLIENTS_2_REDIRECT_URIS_0
            value: /dummy
          - name: KEYCLOAK_CLIENTS_2_ROOT_URL
            value: http://dummy
          - name: KEYCLOAK_CLIENTS_2_TYPE
            value: CONFIDENTIAL
          # Identity access.
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_0_RESOURCE_SERVER_ID
            value: camunda-identity-resource-server
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_0_DEFINITION
            value: read
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_1_RESOURCE_SERVER_ID
            value: camunda-identity-resource-server
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_1_DEFINITION
            value: write
          # Operate access.
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_2_RESOURCE_SERVER_ID
            value: operate-api
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_2_DEFINITION
            value: "read:*"
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_3_RESOURCE_SERVER_ID
            value: operate-api
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_3_DEFINITION
            value: "write:*"
          # Tasklist access.
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_4_RESOURCE_SERVER_ID
            value: tasklist-api
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_4_DEFINITION
            value: "read:*"
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_5_RESOURCE_SERVER_ID
            value: tasklist-api
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_5_DEFINITION
            value: "write:*"
          # Optimize access.
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_6_RESOURCE_SERVER_ID
            value: optimize-api
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_6_DEFINITION
            value: "write:*"
          # Zeebe access.
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_7_RESOURCE_SERVER_ID
            value: zeebe-api
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_7_DEFINITION
            value: "write:*"
          # WebModeler access.
          # NOTE: This actually should be only in the chart-with-web-modeler scenarios,
          # but since Helm doesn't support merge lists it's added here.
          # It could be removed later when the env vars could be configured via ConfigMap.
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_8_RESOURCE_SERVER_ID
            value: web-modeler-api
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_8_DEFINITION
            value: "write:*"
          # Console access.
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_9_RESOURCE_SERVER_ID
            value: console-api
          - name: KEYCLOAK_CLIENTS_2_PERMISSIONS_9_DEFINITION
            value: "write:*"
          - name: KEYCLOAK_CLIENTS_3_ID
            value: test
          - name: KEYCLOAK_CLIENTS_3_NAME
            value: Test
          - name: KEYCLOAK_CLIENTS_3_SECRET
            value: ${{ vars.DISTRO_QA_E2E_TESTS_KEYCLOAK_CLIENTS_SECRET }}
          - name: KEYCLOAK_CLIENTS_3_REDIRECT_URIS_0
            value: /dummy
          - name: KEYCLOAK_CLIENTS_3_ROOT_URL
            value: http://dummy
          - name: KEYCLOAK_CLIENTS_3_TYPE
            value: CONFIDENTIAL
          # Identity access.
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_0_RESOURCE_SERVER_ID
            value: camunda-identity-resource-server
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_0_DEFINITION
            value: read
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_1_RESOURCE_SERVER_ID
            value: camunda-identity-resource-server
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_1_DEFINITION
            value: write
          # Operate access.
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_2_RESOURCE_SERVER_ID
            value: operate-api
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_2_DEFINITION
            value: "read:*"
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_3_RESOURCE_SERVER_ID
            value: operate-api
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_3_DEFINITION
            value: "write:*"
          # Tasklist access.
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_4_RESOURCE_SERVER_ID
            value: tasklist-api
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_4_DEFINITION
            value: "read:*"
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_5_RESOURCE_SERVER_ID
            value: tasklist-api
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_5_DEFINITION
            value: "write:*"
          # Optimize access.
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_6_RESOURCE_SERVER_ID
            value: optimize-api
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_6_DEFINITION
            value: "write:*"
          # Zeebe access.
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_7_RESOURCE_SERVER_ID
            value: zeebe-api
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_7_DEFINITION
            value: "write:*"
          # WebModeler access.
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_8_RESOURCE_SERVER_ID
            value: web-modeler-api
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_8_DEFINITION
            value: "write:*"
          # Console access.
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_9_RESOURCE_SERVER_ID
            value: console-api
          - name: KEYCLOAK_CLIENTS_3_PERMISSIONS_9_DEFINITION
            value: "write:*"
        connectors:
          image:
            tag: ${{ github.event.inputs.connectors_version }}
          env:
          - name: username
            value: username
          - name: password
            value: password