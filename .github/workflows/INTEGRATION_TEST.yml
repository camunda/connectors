
name: Integration test

on:
  push:
    branches:
      - release/*
  workflow_dispatch:
    inputs:
      connectors-version:
        description: 'The version of the connectors to test. If not provided, the version is determined based on the Maven project version. On main branch, the default is SNAPSHOT'
        required: false
      helm-branch:
        description: 'The branch of the Helm chart to test against. If not provided, the branch is determined based on the ref (see helm-git-refs.json)'
        required: false

defaults:
  run:
    # use bash shell by default to ensure pipefail behavior is the default
    # see https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#exit-codes-and-error-action-preference
    shell: bash

jobs:
  prepare-inputs:
    runs-on: ubuntu-latest
    name: Prepare inputs
    outputs:
      connectors-version: ${{ steps.maven-version.outputs.version }}
      helm-branch: ${{ steps.helm-branch.outputs.helm-branch }}
    steps:
      - uses: actions/checkout@v2

      - name: Install jq
        run: sudo apt-get install jq

      - name: Prepare Java and Maven settings
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Determine current Maven project version
        id: maven-version
        run: |
          echo "::set-output name=version::$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)"

      - name: Determine version of the Connectors image to use
        id: connectors-version
        run: |
          if [ -z "${{ github.event.inputs.connectors-version }}" ]; then
            if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              echo "::set-output name=connectors-version::SNAPSHOT"
            else
              echo "::set-output name=connectors-version::${{ steps.maven-version.outputs.version }}"
            fi
          else
            echo "::set-output name=connectors-version::${{ github.event.inputs.connectors-version }}"
          fi

      - name: Determine Helm chart ref to use
        run: |
          if [ -z "${{ github.event.inputs.helm-branch }}" ]; then
            helm_branch=$(jq -r ".[\"${{ github.ref }}\"]" .github/workflows/helm-git-refs.json)
            if [ -z "$helm_branch" ]; then
              echo "::error::Could not determine Helm chart branch to use, please provide helm-branch input or adjust the mappings in .github/workflows/helm-git-refs.json"
              exit 1
            fi
            echo "::set-output name=helm-branch::$helm_branch"
          else
            echo "::set-output name=helm-branch::${{ github.event.inputs.helm-branch }}"
          fi

  helm-deploy:
    needs: prepare-inputs
    name: Helm chart Integration Tests
    uses: camunda/camunda-platform-helm/.github/workflows/test-integration-template.yaml@main
    secrets: inherit
    with:
      identifier: connectors-int
      camunda-helm-git-ref: ${{ needs.prepare-inputs.outputs.helm-branch }}
      test-enabled: true
      extra-values: |
        connectors:
          image:
            tag: ${{ needs.prepare-inputs.outputs.connectors-version }}
