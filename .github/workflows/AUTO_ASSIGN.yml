name: Auto Assign PR Reviewers

on:
  pull_request:
    types: [ opened, ready_for_review, review_requested ]

jobs:
  fork-guard:
    name: Skip if external fork
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository }}
    steps:
      - name: Explain skip in logs
        run: |
          echo "ðŸ›‘ External fork; skipping auto-assignment."
          echo "Push to a branch in the main repository to run full CI."

  auto-assign:
    runs-on: ubuntu-latest
    # Only run if:
    # 1. The PR is not from a fork (security requirement)
    # 2. The "connectors" team is in the requested reviewers
    if: |
      github.event.pull_request.head.repo.full_name == github.repository &&
      contains(github.event.pull_request.requested_teams.*.slug, 'connectors')

    steps:
      - name: Import Secrets
        id: vault-secrets
        uses: hashicorp/vault-action@v3.4.0
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID}}
          secrets: |
            secret/data/products/connectors/ci/common GITHUB_APP_ID;
            secret/data/products/connectors/ci/common GITHUB_APP_PRIVATE_KEY;
      - name: Generate a GitHub token for connectors
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ steps.vault-secrets.outputs.GITHUB_APP_ID }}
          private-key: ${{ steps.vault-secrets.outputs.GITHUB_APP_PRIVATE_KEY }}
      - name: Fetch Team Members
        id: get-members
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail
          echo "Fetching team members for team 'connectors-dev'..."
          TEAM_MEMBERS=$(gh api orgs/camunda/teams/connectors-dev/members --jq '[.[].login] | join(",")' || echo "")
          if [ -z "$TEAM_MEMBERS" ]; then
            echo "Error: Failed to fetch team members or team has no members." >&2
            echo "Please check GitHub token permissions, team slug, and API rate limits." >&2
            exit 1
          fi
          echo "Fetched team members: $TEAM_MEMBERS"
          echo "team_members=$TEAM_MEMBERS" >> "$GITHUB_OUTPUT"
      - name: Assign Reviewer
        uses: Joxtacy/auto-assign-reviewers@v0.1.0
        with:
          github_token: ${{ steps.app-token.outputs.token }}
          team_members: ${{ steps.get-members.outputs.team_members }}
          # Adjust these weights to prioritize different factors
          weight_open_prs: 0          # Default: 10
          weight_lines_per_100: 0     # Default: 1
          weight_recent_reviews: 10   # Default: 3