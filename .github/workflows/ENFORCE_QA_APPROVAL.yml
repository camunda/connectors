name: Enforce Specific QA Approval for "feat" PRs

on:
  pull_request:
    types: [opened, edited, synchronize]
    pull_request_review:
      types: [ submitted ]

jobs:
  enforce-approval:
    runs-on: ubuntu-latest

    steps:
      - name: Check PR Title and Specific Dev Approval
        uses: actions/github-script@v6
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            const prNumber = context.payload.pull_request.number;
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;

            const requiredDev = "@Szik";

            if (prTitle.startsWith("feat")) {
              const reviews = await github.rest.pulls.listReviews({
                owner: repoOwner,
                repo: repoName,
                pull_number: prNumber,
              });

              const hasApproved = reviews.data.some(review => 
                review.user.login === requiredDev && review.state === "APPROVED"
              );

              if (hasApproved) {
                await github.rest.repos.createCommitStatus({
                  owner: repoOwner,
                  repo: repoName,
                  sha: context.payload.pull_request.head.sha,
                  state: "success",
                  context: "QA-approval",
                  description: `${requiredDev} has approved this PR.`,
                });
              } else {
                await github.rest.repos.createCommitStatus({
                  owner: repoOwner,
                  repo: repoName,
                  sha: context.payload.pull_request.head.sha,
                  state: "failure",
                  context: "QA-approval",
                  description: `${requiredDev} approval is required for 'feat' PRs.`,
                });
              }
            } else {
              await github.rest.repos.createCommitStatus({
                owner: repoOwner,
                repo: repoName,
                sha: context.payload.pull_request.head.sha,
                state: "success",
                context: "QA-approval",
                description: "No specific approval required for non-'feat' PRs.",
              });
            }
