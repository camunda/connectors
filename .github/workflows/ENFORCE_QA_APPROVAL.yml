name: Enforce Specific QA Approval for "feat" PRs

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  enforce-approval:
    runs-on: ubuntu-latest

    steps:
      - name: Check PR Title and Specific Dev Approval
        uses: actions/github-script@v6
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            const prNumber = context.payload.pull_request.number;
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;

            const requiredDev = "specific-dev"; // Replace with the actual username

            if (prTitle.startsWith("feat")) {
              console.log("PR title starts with 'feat'. Checking approval by specific developer.");

              // Fetch the reviews for the PR
              const reviews = await github.rest.pulls.listReviews({
                owner: repoOwner,
                repo: repoName,
                pull_number: prNumber,
              });

              // Check if the specific developer has approved
              const hasApproved = reviews.data.some(review => 
                review.user.login === requiredDev && review.state === "APPROVED"
              );

              if (hasApproved) {
                console.log(`PR has been approved by ${requiredDev}.`);
                await github.rest.repos.createCommitStatus({
                  owner: repoOwner,
                  repo: repoName,
                  sha: context.payload.pull_request.head.sha,
                  state: "success",
                  context: "specific-dev-approval",
                  description: `${requiredDev} has approved this PR.`,
                });
              } else {
                console.log(`PR has not been approved by ${requiredDev}.`);
                await github.rest.repos.createCommitStatus({
                  owner: repoOwner,
                  repo: repoName,
                  sha: context.payload.pull_request.head.sha,
                  state: "failure",
                  context: "specific-dev-approval",
                  description: `${requiredDev} approval is required for 'feat' PRs.`,
                });
              }
            } else {
              console.log("PR title does not start with 'feat'. No specific approval required.");
              await github.rest.repos.createCommitStatus({
                owner: repoOwner,
                repo: repoName,
                sha: context.payload.pull_request.head.sha,
                state: "success",
                context: "specific-dev-approval",
                description: "No specific approval required for non-'feat' PRs.",
              });
            }
